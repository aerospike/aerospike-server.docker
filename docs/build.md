# Release Process

-	[First Time Docker Buildx Setup](#first-time-docker-buildx-setup)
-	[First Time Git Clone](#first-time-git-clone)
-	[Build Procedure](#build-procedure)
-	[About update.sh](#about-updatesh)
-	[About build.sh](#about-buildsh)
-	[About test.sh](#about-testsh)

## First Time Docker Buildx Setup

These scripts use `docker buildx` for multi-architecture builds, buildx may need to be setup if it isn't already.

To check if your current builder support ARM run:

```shell
docker buildx inspect | grep -q "linux/arm" && echo "Builder supports ARM" || echo -e "\033[0;31mARM NOT supported by builder\033[0m"
```

If above outputs "Builder supports ARM" then proceed.

If the output was "ARM NOT supported by builder" then run the following to setup a builder that supports ARM.

```shell
docker run --privileged --rm tonistiigi/binfmt --install all 
docker buildx create --name mybuilder --driver docker-container --bootstrap --use
```

## First Time Git Clone

The following procedures assume that your current working directory is the root of the `aerospike-server.docker` repository.

```shell
git clone <org>/aerospike-server.docker
cd aerospike-server.docker
```

## Build Procedure

1.	Checkout master and pull.

	```shell
	git checkout master
	git pull origin master
	```

2.	Run `update.sh` with target version.

	```shell
	./update.sh
	```

3.	After the update script has run, commit the changes and tag the release.

	```shell
	git add images
	git commit -m "Adding version #.#"
	```

4.	Verify the tag format is correct.

	```shell
	./update.sh 2>/dev/null && [ -z "$(git diff --stat)" ] && echo "Tag is good" || echo -e "\033[0;31mBad Tag\033[0m"
	```

5.	Build test images and test.

	```shell
	./build.sh -t
	./test.sh --clean
	```

6.	Build image for publishing and publish.

	```shell
	./build.sh -p
	```

7.	Push changes to GitHub.

	```shell
	git push origin master --tags
	```

## About update.sh

The `update.sh` script will finds the latest release for each version in the `data/config/` directory. The `config.sh` and `config_<edition>.sh` inform the script of which server editions, linux distributions, and hardware platforms are supported by the version parent directory in `data/config/`.

The `update.sh` script is also used in GitHub actions - the github action will fail if there are uncommitted changes after running `update.sh`.

## About build.sh

The `build.sh` script  uses the same `data/config` files to determine editions, etc. The script generates `target/bake.hcl` which defines all the images and tags to be built. There are two groups of images: "test" and "push". The "test" group is consumed by `test.sh` and built by running `./build.sh -t`. The "push" group are the published images. The reason for the two groups is that the `test.sh` script currently cannot test local multi-platform images which are generated by the `-p` option.

Currently we are unable to test multi-platform docker images without pushing those images to a registry. To work around this issue, build has two modes, test and push. The test mode allows the `test.sh` to locally verify that the docker containers are functioning properly. The push mode builds and publishes the multi-platform containers.

## About test.sh

The `test.sh` script uses the same `data/config` files to determine editions, etc. The script will test each image generated by `./build.sh -t`.

Currently it performs the following tests:

1.	The container is running.
2.	The container is running with the target platform.
3.	The Aerospike process has started.
4.	The Aerospike database responds to info commands.
5.	The Aerospike database is running the expected version.
6.	The Aerospike database is running the expected edition.

The `test.sh` script's `--clean` option removes the test images after the tests complete successfully.
